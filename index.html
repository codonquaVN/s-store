<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S+ STORE ‚Ä¢ H√≥a ƒë∆°n b√°n h√†ng</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#0a8a52;--muted:#666;--paper:#fff;--page-width:1100px;}
    body{font-family:'Roboto',Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#111;transition:filter 2s ease,opacity 2s ease;}
    body.blurred{filter:blur(6px);opacity:0.3;}
    .wrap{max-width:var(--page-width);margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    @media(min-width:980px){.grid{grid-template-columns:450px 1fr;}}
    .card{background:var(--paper);border-radius:8px;padding:16px;box-shadow:0 6px 18px rgba(20,30,40,0.06);}
    h1{margin:0;font-size:20px;color:var(--accent);text-align:center;font-weight:700}
    h3{margin:0 0 12px 0;font-size:16px;color:#333;border-bottom:2px solid var(--accent);padding-bottom:8px}
    .small{font-size:13px;color:var(--muted)}
    label{display:block;font-weight:600;margin-top:12px;font-size:14px;color:#333}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d8dbe0;border-radius:6px;box-sizing:border-box;font-size:15px;margin-top:6px;}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(10,138,82,0.1);}
    textarea{min-height:70px;resize:vertical;}
    .row{display:flex;gap:10px;}
    .col{flex:1}
    .btn{display:inline-block;padding:12px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:700;font-size:15px;transition:all 0.2s}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:#087d48;transform:translateY(-1px);box-shadow:0 4px 12px rgba(10,138,82,0.3)}
    .btn-ghost{background:#fff;border:2px solid #ddd;color:#333}
    .btn-danger{background:#c40000;color:#fff}
    .text-right{text-align:right}
    .bold{font-weight:700}
    .center{text-align:center}
    #login-container{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);z-index:1000;}
    #login-box{background:#fff;padding:30px 40px;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,0.1);text-align:center;}
    #login-box input{display:block;width:250px;margin:10px auto;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:16px;}
    #logout-btn{position:fixed;top:10px;right:15px;background:#c40000;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:14px;display:none;z-index:2000;}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-container">
  <div id="login-box">
    <h2>ƒêƒÉng nh·∫≠p S-STORE</h2>
    <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" autocomplete="off" />
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" />
    <button id="login-btn">ƒêƒÉng nh·∫≠p</button>
    <p id="login-message" style="color:red;margin-top:10px;"></p>
  </div>
</div>
<button id="logout-btn">ƒêƒÉng xu·∫•t</button>

<!-- APP CONTENT -->
<div class="wrap">
  <h1>S+ Store - H√ìA ƒê∆†N B√ÅN H√ÄNG & D·ªäCH V·ª§</h1>
  <p class="small center">S·ªê 1 ng√µ 50 L∆Ø∆†NG TH·∫æ VINH - H√Ä N·ªòI</p>

  <div class="grid">
    <!-- FORM -->
    <div class="card no-print">
      <h3>üìã Th√¥ng tin h√≥a ƒë∆°n</h3>

      <label>Ch·ªçn ch·ªß t√†i kho·∫£n</label>
      <select id="ownerSelect"></select>
      <div class="row">
        <div class="col">
          <label>T√™n ch·ªß TK</label><input id="ownerName" type="text" readonly>
          <label>Ng√¢n h√†ng & STK</label><input id="ownerBank" type="text" readonly>
          <label>Li√™n h·ªá</label><input id="ownerContact" type="text" readonly>
        </div>
        <div style="width:110px;text-align:center;">
          <label style="font-size:12px">QR chuy·ªÉn kho·∫£n</label>
          <img id="ownerQR" alt="QR" style="width:92px;height:92px;border:1px solid #ddd;border-radius:6px;">
        </div>
      </div>

      <label>Ng√†y h√≥a ƒë∆°n</label>
      <input id="invoiceDate" type="date">
      <label>T√™n kh√°ch h√†ng</label>
      <input id="tenkhach" type="text">
      <label>S·ªë ƒëi·ªán tho·∫°i</label>
      <input id="sdt" type="text">
      <label>ƒê·ªãa ch·ªâ</label>
      <input id="diachi" type="text">
      <h3>üõí S·∫£n ph·∫©m / D·ªãch v·ª•</h3>
      <div id="productCards"></div>
      <button class="btn btn-ghost" onclick="addProductCard()">+ Th√™m s·∫£n ph·∫©m</button>

      <label>Ghi ch√∫</label>
      <textarea id="ghichu"></textarea>
      <input id="invoiceId" type="hidden">
      <div class="actions">
        <button class="btn btn-primary" onclick="handleSave(false)">üíæ L∆∞u & Xem</button>
        <button class="btn btn-primary" onclick="handleSave(true)">üñ®Ô∏è L∆∞u & In</button>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="card preview">
      <div id="invoicePreview" style="display:none">
        <p><b>Kh√°ch h√†ng:</b> <span id="pvCustomer"></span></p>
        <p><b>ƒê·ªãa ch·ªâ:</b> <span id="pvAddress"></span></p>
        <p><b>Ng√†y:</b> <span id="pvDate"></span></p>
        <table class="inv-table" border="1" width="100%">
          <thead><tr><th>T√™n SP</th><th>SL</th><th>Gi√°</th><th>Gi·∫£m</th><th>T·ªïng</th></tr></thead>
          <tbody id="pvItems"></tbody>
          <tfoot><tr><td colspan="4">T·ªïng</td><td id="pvTotal"></td></tr></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwFpImQ0gEaAYhKXLHgkQWGPxzQPcQLXjTYa-dXSgT_zDHXdmOGk31UjF1U5GXrWfw_/exec';

function el(id){return document.getElementById(id);}
function addProductCard(){
  const div=document.createElement('div');
  div.className='product-card';
  div.innerHTML=`<label>T√™n SP</label><input class="product-name">
                 <label>SL</label><input type="number" class="product-qty" value="1">
                 <label>Gi√°</label><input type="number" class="product-price">
                 <label>Gi·∫£m</label><input type="number" class="product-discount">`;
  el('productCards').appendChild(div);
}
addProductCard();

function getProducts(){
  const arr=[]; document.querySelectorAll('.product-card').forEach(c=>{
    arr.push({
      name:c.querySelector('.product-name').value,
      qty:+c.querySelector('.product-qty').value||1,
      price:+c.querySelector('.product-price').value||0,
      discount:+c.querySelector('.product-discount').value||0
    });
  }); return arr;
}

function formatMoney(n){return new Intl.NumberFormat('vi-VN').format(n);}
function numberToWords(n){return n.toString();} // ƒë∆°n gi·∫£n h√≥a

function renderPreview(inv){
  el('pvCustomer').textContent=inv.tenkhach;
  el('pvAddress').textContent=inv.diachi;
  el('pvDate').textContent=inv.date;
  const tbody=el('pvItems'); tbody.innerHTML='';
  let total=0;
  inv.products.forEach(p=>{
    const t=(p.price-p.discount)*p.qty; total+=t;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td>${p.qty}</td><td>${formatMoney(p.price)}</td><td>${formatMoney(p.discount)}</td><td>${formatMoney(t)}</td>`;
    tbody.appendChild(tr);
  });
  el('pvTotal').textContent=formatMoney(total);
  el('invoicePreview').style.display='block';
}

function handleSave(print=false){
  const inv={
    tenkhach:el('tenkhach').value, diachi:el('diachi').value,
    date:new Date().toLocaleDateString('vi-VN'),
    products:getProducts()
  };
  renderPreview(inv);
  sendToGoogleSheets(inv);
  if(print) setTimeout(()=>window.print(),500);
}

function sendToGoogleSheets(invoice){
  let total=0, list='';
  invoice.products.forEach((p,i)=>{
    total+=(p.price-p.discount)*p.qty;
    list+=(i?', ':'')+p.name;
  });
  const data={
    datetime:new Date().toLocaleString('vi-VN'),
    invoiceId:'INV-'+Date.now(),
    customerName:invoice.tenkhach,
    address:invoice.diachi,
    products:list,
    total:total
  };
  const xhr=new XMLHttpRequest();
  xhr.open('POST',WEBAPP_URL,true);
  xhr.setRequestHeader('Content-Type','application/json');
  xhr.onload=function(){
    console.log('Response:',xhr.responseText);
    alert('Server tr·∫£ v·ªÅ: '+xhr.responseText);
  };
  xhr.onerror=function(e){
    alert('‚ö†Ô∏è Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu t·ªõi Google Sheet!\n'+e);
  };
  xhr.send(JSON.stringify(data));
}
</script>
</body>
</html>
